name: ci

on:
  push:
    branches: [main]
    tags: ['*']
  pull_request:
    branches: [main]

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install python deps
        run: pip install -r requirements.txt

      - name: Lint
        run: python -m py_compile on_receive.py

      - name: Run unit tests and fail if none are found
        run: |
          set -e
          output=$(python -m unittest discover -s tests -v)
          echo "$output"
          if echo "$output" | grep -q 'Ran 0 tests'; then
            echo "ERROR: No tests were executed."
            exit 1
          fi

      - name: Set image tags
        if: github.event_name != 'pull_request'
        id: vars
        run: |
          REPO=ghcr.io/$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')
          TAGS="$REPO:${GITHUB_SHA}"
          if [ "${GITHUB_REF_TYPE}" = "tag" ]; then
            TAGS="$TAGS,$REPO:${GITHUB_REF_NAME}"
          fi
          if [ "${GITHUB_REF}" = "refs/heads/main" ]; then
            TAGS="$TAGS,$REPO:latest"
          fi
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "IMAGE=$REPO" >> $GITHUB_ENV

      - uses: docker/setup-buildx-action@v3
        if: github.event_name != 'pull_request'

      - name: Build Docker image
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: ${{ steps.vars.outputs.tags }}

      - name: Run all tests inside built Docker image
        if: github.event_name != 'pull_request'
        run: |
          IMAGE=$(echo "${{ steps.vars.outputs.tags }}" | cut -d',' -f1)
          docker run --rm \
            -e DEVICE=/dev/null -e BAUDRATE=9600 \
            -e TELEGRAM_BOT_TOKEN=dummy -e TELEGRAM_CHAT_ID=dummy \
            -e GAMMU_SPOOL_PATH=/tmp/gammu -e GAMMU_CONFIG_PATH=/tmp/smsdrc \
            "$IMAGE" python3 -m unittest discover -s tests -v

      - name: Smoke test container
        if: github.event_name != 'pull_request'
        run: |
          IMAGE=$(echo "${{ steps.vars.outputs.tags }}" | cut -d',' -f1)
          docker run --rm -e DEVICE=/dev/null -e BAUDRATE=9600 \
            -e TELEGRAM_BOT_TOKEN=dummy -e TELEGRAM_CHAT_ID=dummy \
            -e GAMMU_SPOOL_PATH=/tmp/gammu -e GAMMU_CONFIG_PATH=/tmp/smsdrc \
            "$IMAGE" --dry-run
          docker run --rm --entrypoint gammu-smsd "$IMAGE" --version

      - uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push Docker image
        if: github.event_name != 'pull_request'
        run: |
          for tag in $(echo "${{ steps.vars.outputs.tags }}" | tr ',' ' '); do
            docker push "$tag"
          done
